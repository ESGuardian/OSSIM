## Русификация ##

**Для русификации теперь можно и нужно использовать скрипт** `/usr/local/bin/jailbreak/jailbreak-ossim-for-rus.sh`   
Больше ничего делать не надо. Скрипт применим также к AlienVault USM. Можно запускать скрипт повторно, например, в случае мажорного апдейта системы. В скрипте делается проверка необходимости изменений перед их выполнением.

### Что делается и зачем? ###
Чтобы плагины могли обрабатывать логи (или данные импортируемые из СУБД) в кодировке отличной от latin1 им нужно на это указать. Разумно указать в файле конфигурации соответствующего плагина. Но вот беда. В синтаксисе файлов конфигурации такого параметра нет. На самом деле он есть, но в другом месте и эта особенность нигде не документирована. Узнать о ней вы можете только прочитав исходный код модулей, которые составляют ossim-agent: `/usr/share/alienvault/ossim-agent`. Здесь лежит код генератора объектов типа Plugin, которые запускаются агентом. Перечень плагинов, которые должны быть сгенерированы и запущены при старте агента содержится в файле `/etc/ossim/agent/config.cfg` в виде путей к файлам конфигурации каждого плагина. Так вот. Когда генератор плагинов читает этот файл он проверяет наличие в конце строки, обозначающей путь к конфиг-файлу плагина подстроки вида "`|encoding`", где "encoding" - номер кодовой строницы, например, cp1251. Если такая подстрока есть, он записывает номер кодовой страницы в свойство encoding объекта Plugin. Иначе записывает туда latin1.   

Как используется это свойство?  
Во-первых, при чтении файла источника логов. Он открывается для чтения с указанием кодировки из Plugin.encoding. Считываемые строки при этом переводятся во "внутреннюю кодировку". В нашем случае это Unicode.   
Во-вторых, при чтении самого конфиг-файла плагина. Фишка в том, что в конфиг-файле плагина содержатся регулярные выражения для парсинга строк из логов. Плагины всегда работают с регулярками в юникоде. Значит генератору плагинов надо знать из какой кодировки перевести регулярки в юникод. Именно по этой причине параметр, указывающий на кодировку, надо передать генератору плагинов до того, как он откроет конфиг-файл плагина и начнет его генерировать. Вот по этой причине параметр задается не внутри конфиг-файла, а "снаружи".  

Это процесс чтения. А есть еще процесс записи нарезанных из логов событий в базу данных. Здесь тоже необходима конвертация из "внутренней" кодировки в кодировку базы данных. Это уже определяется настройками в файле конфигурации MySQL. Их надо выставить в UTF-8, чтобы все языки могли нормально приниматься. 
 
Есть еще парочка важных мест. Плагины бывают разных типов. Те, что читают данные из логов, и те, что читают из других баз данных. Последние используют в качестве драйвера доступа FreeTDS. Соответственно в конфиг-файле для FreeTDS так же нужно указать какую кодировку использовать при подключении к серверу БД. Там это можно сделать для каждого сервера индивидуально. Я записываю кодировку UTF-8 в качестве глобального параметра.   
И напоследок веб-сервер apache2. Ему тоже надо сказать, что кодировка файлов UTF-8.


Но это еще не всё.   
При апдейте OSSIM запросто может перезаписать всё эти параметры на свои собственные. Следовательно надо придумать способ это проверить и восстановить. Я придумал такой простой способ. У меня есть маленькие скрипты на питоне, которые проверяют нужные параметры в конфиг-файлах и если их там нет, записывают. Эти маленькие скрипты я вставляю в файлы инициализации апача, агента ossim и mysql, в те, что лежат в `/etc/init.d/`. Поскольку любой апдейт заканчивается рестартом соответствующих сервисов, то выполняется моя проверка и правка конфигурации. Таким образом апдейты становятся "безвредными".

Вот теперь всё. Это всё и выполняет мой скрипт. Он создает "проверочные скрипты" кладет их в нужный каталог, правит скрипты в /etc/init.d/, редактирует конфигурационные файлы.

И еще немного интересных фактов о записи данных в базу SIEM. На самом деле ossim agent не пишет данные непосредственно в БД. Этим занимается ossim server. Агент пакует данные, обработанные плагинами в некий общий формат и передает их серверу. Это так специально сделано, чтобы можно было отдать данные произвольному обработчику. Я в деталях не разбирался, как именно он это делает. Явно используется модуль BSON и в качестве "промежуточного носителя" файл agent.log, куда всё пишется в base64-encoding. Интересно в каком виде сервер помещает данные в БД. Там есть особенность с полем data_payload в таблице extra_data. Это поле имеет тип text, а не varchar, как остальные текстовые поля. Соответственно, строки там хранятся ни в каком ни в Юникоде, а в виде байтов (то же, что и BLOB). Это следует учитывать при обработке данных в собственных программах. В частности на питоне вызов функции конвертации unicode(row[i]) (где - row есть тапл значений выбранной из базы строки) правильно отработает для всех полей, а для data_payload выдаст ошибку. Я по этой причине на этом поле использую функцию str(row[i]).decode('utf8'), поскольку в питоне string по сути байты.

По этой же причине есть сложности с заданием фильтра событий по параметру payload в веб-интерфейсе консоли OSSIM. Там можно увидеть два способа задать строку поиска: как код ASCII или как Hex. Что именно авторы подразумевают по Hex, мне понять не удалось. Я не смог выполнить поиск по шестнадцатеричной строке никак. И всем рекомендую, если вы хотите искать данные по содержимому RAW лога,  при создании своих плагинов записывайте RAW в какое-нибудь из полей Userdata1-9, там вы их сможете легко искать на русском языке.